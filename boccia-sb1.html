<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Boccia Score">
    <title>地板滾球智慧記分板 (通用版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        button { touch-action: manipulation; -webkit-tap-highlight-color: transparent; user-select: none; }
        .no-select { user-select: none; -webkit-user-select: none; }
        body { padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }
        .boccia-ball { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); background-color: transparent; }
        .ball-red { border: 3px solid #dc2626; }
        .ball-red.ball-filled { background-color: #dc2626; box-shadow: 0 0 8px rgba(220, 38, 38, 0.6); }
        .ball-blue { border: 3px solid #0284c7; }
        .ball-blue.ball-filled { background-color: #0284c7; box-shadow: 0 0 8px rgba(2, 132, 199, 0.6); }
        
        /* 隱藏捲軸但保留捲動功能 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="h-screen bg-slate-900 text-white font-sans p-2 md:p-4 flex flex-col items-center overflow-hidden">

    <!-- 頂部資訊列 -->
    <div class="w-full max-w-[1800px] flex justify-between items-center mb-2 px-2 z-10 h-14 shrink-0">
        <div class="flex items-center gap-2 md:gap-4">
            <button onclick="toggleModal('settings-modal', true)" class="bg-slate-800 text-blue-400 px-3 py-2 rounded-lg font-bold flex items-center gap-2 hover:bg-slate-700 transition text-sm md:text-base border border-slate-700">
                <i data-lucide="settings" width="18"></i>
                <span id="header-mode-text" class="hidden md:inline">設定</span>
            </button>
            
            <div id="jack-indicator" class="bg-slate-800 text-slate-300 px-3 py-2 rounded-lg font-bold text-xs md:text-sm border border-slate-600">
                準備開始
            </div>
        </div>
        <button onclick="toggleModal('help-modal', true)" class="bg-slate-800 p-2 rounded-lg text-slate-400 hover:text-white transition">
            <i data-lucide="info" width="20"></i>
        </button>
    </div>

    <!-- 主內容區 -->
    <div class="w-full max-w-[1800px] grid grid-cols-1 lg:grid-cols-10 gap-2 lg:gap-4 relative flex-grow items-stretch pb-2 overflow-y-auto no-scrollbar overscroll-contain">

        <!-- 紅隊區域 -->
        <div id="red-panel" class="lg:col-span-4 bg-slate-800/50 rounded-3xl border-t-8 border-red-600 p-2 md:p-4 flex flex-col justify-between transition-all duration-300 relative overflow-hidden min-h-[400px] lg:min-h-0">
            <div id="red-active-bg" class="absolute inset-0 bg-red-600/10 hidden pointer-events-none"></div>
            
            <div class="z-10 w-full text-center">
                <input type="text" id="red-name" class="bg-transparent text-center w-full text-2xl md:text-3xl font-bold focus:outline-none focus:border-b border-red-500/50 text-red-100 placeholder-red-800/50" value="紅隊 (Red)">
            </div>

            <!-- 分數區 -->
            <div class="z-10 flex-grow flex flex-col items-center justify-center py-2">
                <div class="flex items-center justify-center w-full gap-2 md:gap-6">
                    <button onclick="adjustScore('red', -1)" class="w-12 h-12 md:w-16 md:h-16 rounded-full bg-slate-800/50 hover:bg-slate-700 text-slate-400 hover:text-white flex items-center justify-center transition active:scale-95">
                        <i data-lucide="minus" class="w-6 h-6 md:w-8 md:h-8"></i>
                    </button>
                    <div id="red-score" class="text-[8rem] md:text-[10rem] lg:text-[13rem] font-black text-red-500 leading-none tabular-nums drop-shadow-2xl select-none transition-all">0</div>
                    <button onclick="adjustScore('red', 1)" class="w-12 h-12 md:w-16 md:h-16 rounded-full bg-red-900/30 hover:bg-red-600 text-red-400 hover:text-white flex items-center justify-center transition active:scale-95 border border-red-500/30">
                        <i data-lucide="plus" class="w-6 h-6 md:w-8 md:h-8"></i>
                    </button>
                </div>
                <div class="text-red-500/30 font-bold uppercase tracking-[0.5em] text-xs md:text-sm mt-[-10px] md:mt-[-20px] select-none">SCORE</div>
            </div>

            <!-- 底部操作區 -->
            <div class="z-10 flex flex-col items-center gap-3 w-full">
                <button onclick="activateSide('red')" id="red-timer-btn" class="text-5xl md:text-6xl lg:text-7xl font-mono font-bold text-red-400 hover:text-white transition bg-slate-900/40 px-6 py-1 md:py-2 rounded-2xl border-2 border-red-500/20 hover:border-red-500 active:scale-95 shadow-lg w-full max-w-[320px]">
                    02:00
                </button>

                <div class="flex items-center justify-between w-full px-2">
                    <div class="flex gap-2 p-2 bg-slate-900/30 rounded-xl" id="red-balls-container"></div>
                    <div class="flex items-center gap-2 bg-red-900/20 px-2 py-1 rounded border border-red-900/30">
                        <span class="text-[10px] text-red-300">罰球</span>
                        <span id="red-penalty-count" class="text-red-400 font-bold text-sm">0</span>
                        <button onclick="addPenaltyBall('red')" class="bg-red-800 text-white rounded w-5 h-5 flex items-center justify-center text-xs hover:bg-red-700">+</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 中控區域 -->
        <div class="lg:col-span-2 flex flex-col gap-2 h-full min-h-[200px] lg:min-h-0">
            <div class="bg-slate-800 rounded-2xl p-2 flex-grow flex flex-col items-center justify-center text-center shadow-xl border border-slate-700 min-h-[160px]">
                <div class="flex flex-col items-center justify-center flex-grow">
                    <div class="text-slate-500 text-[10px] font-bold uppercase tracking-widest mb-1">Class</div>
                    <div id="center-class-display" class="text-4xl lg:text-6xl font-black text-white drop-shadow-lg mb-4">BC1</div>
                    <div class="w-12 h-1 bg-slate-700 rounded-full mb-4"></div>
                    <div id="round-info">
                        <div class="text-slate-500 text-[10px] font-bold uppercase tracking-widest mb-1">Status</div>
                        <div class="text-2xl lg:text-3xl font-bold text-amber-400 truncate px-1" id="center-end-text-container">
                            <span id="center-end-display" class="text-white text-3xl lg:text-5xl mx-1">暖身</span>
                        </div>
                        <div class="text-slate-500 text-[10px] mt-1" id="total-ends-container">Warm Up (2:00)</div>
                    </div>
                </div>
            </div>

            <div class="flex flex-col gap-2 shrink-0">
                <button onclick="nextEnd()" id="next-btn" class="py-3 md:py-4 bg-emerald-600 text-white rounded-xl font-bold hover:bg-emerald-500 transition shadow-lg flex items-center justify-center gap-2 text-sm md:text-base group">
                    <i data-lucide="play-circle" width="18"></i> 
                    <span id="next-btn-text">開始比賽</span>
                </button>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="toggleModal('reset-modal', true)" class="py-2 md:py-3 bg-slate-700 text-slate-300 rounded-xl font-medium hover:bg-slate-600 text-xs md:text-sm">重置本局</button>
                    <button onclick="endMatch()" class="py-2 md:py-3 bg-slate-800 border border-slate-600 text-slate-400 rounded-xl font-medium hover:bg-red-900/30 hover:text-red-400 text-xs md:text-sm">結束比賽</button>
                </div>
            </div>
        </div>

        <!-- 藍隊區域 -->
        <div id="blue-panel" class="lg:col-span-4 bg-slate-800/50 rounded-3xl border-t-8 border-sky-600 p-2 md:p-4 flex flex-col justify-between transition-all duration-300 relative overflow-hidden min-h-[400px] lg:min-h-0">
            <div id="blue-active-bg" class="absolute inset-0 bg-sky-600/10 hidden pointer-events-none"></div>

            <div class="z-10 w-full text-center">
                <input type="text" id="blue-name" class="bg-transparent text-center w-full text-2xl md:text-3xl font-bold focus:outline-none focus:border-b border-sky-500/50 text-sky-100 placeholder-sky-800/50" value="藍隊 (Blue)">
            </div>

            <div class="z-10 flex-grow flex flex-col items-center justify-center py-2">
                <div class="flex items-center justify-center w-full gap-2 md:gap-6">
                    <button onclick="adjustScore('blue', -1)" class="w-12 h-12 md:w-16 md:h-16 rounded-full bg-slate-800/50 hover:bg-slate-700 text-slate-400 hover:text-white flex items-center justify-center transition active:scale-95">
                        <i data-lucide="minus" class="w-6 h-6 md:w-8 md:h-8"></i>
                    </button>
                    <div id="blue-score" class="text-[8rem] md:text-[10rem] lg:text-[13rem] font-black text-sky-500 leading-none tabular-nums drop-shadow-2xl select-none transition-all">0</div>
                    <button onclick="adjustScore('blue', 1)" class="w-12 h-12 md:w-16 md:h-16 rounded-full bg-sky-900/30 hover:bg-sky-600 text-sky-400 hover:text-white flex items-center justify-center transition active:scale-95 border border-sky-500/30">
                        <i data-lucide="plus" class="w-6 h-6 md:w-8 md:h-8"></i>
                    </button>
                </div>
                <div class="text-sky-500/30 font-bold uppercase tracking-[0.5em] text-xs md:text-sm mt-[-10px] md:mt-[-20px] select-none">SCORE</div>
            </div>

            <div class="z-10 flex flex-col items-center gap-3 w-full">
                <button onclick="activateSide('blue')" id="blue-timer-btn" class="text-5xl md:text-6xl lg:text-7xl font-mono font-bold text-sky-400 hover:text-white transition bg-slate-900/40 px-6 py-1 md:py-2 rounded-2xl border-2 border-sky-500/20 hover:border-sky-500 active:scale-95 shadow-lg w-full max-w-[320px]">
                    02:00
                </button>

                <div class="flex items-center justify-between w-full px-2">
                    <div class="flex gap-2 p-2 bg-slate-900/30 rounded-xl" id="blue-balls-container"></div>
                    <div class="flex items-center gap-2 bg-sky-900/20 px-2 py-1 rounded border border-sky-900/30">
                        <span class="text-[10px] text-sky-300">罰球</span>
                        <span id="blue-penalty-count" class="text-sky-400 font-bold text-sm">0</span>
                        <button onclick="addPenaltyBall('blue')" class="bg-sky-800 text-white rounded w-5 h-5 flex items-center justify-center text-xs hover:bg-sky-700">+</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Modals -->

    <!-- 特殊暫停全螢幕倒數 Modal -->
    <div id="timeout-active-modal" class="hidden fixed inset-0 z-[130] bg-black/95 flex items-center justify-center p-4 backdrop-blur-md">
        <div class="w-full max-w-4xl text-center relative">
            <h2 id="timeout-title" class="text-4xl md:text-6xl font-black text-white mb-12 animate-pulse">醫療暫停</h2>
            <div id="timeout-timer" class="text-[8rem] md:text-[16rem] font-mono font-black text-white leading-none tabular-nums mb-12">10:00</div>
            <div class="flex justify-center gap-6">
                <button onclick="endSpecialTimeout()" class="bg-slate-700 border-2 border-slate-500 hover:bg-slate-600 text-white px-10 py-5 rounded-3xl font-bold text-2xl transition">
                    結束暫停 (Resume)
                </button>
            </div>
            <div class="mt-8 text-slate-500 text-sm">規則 19.1 & 20.1: 暫停時間為 10 分鐘</div>
        </div>
    </div>

    <!-- 罰球執行 Modal -->
    <div id="penalty-modal" class="hidden fixed inset-0 z-[110] bg-slate-900/95 flex items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-slate-800 border-4 border-slate-600 p-8 md:p-12 rounded-[3rem] max-w-2xl w-full text-center shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-4 bg-slate-600" id="penalty-bar"></div>
            
            <div class="mb-6">
                <div class="uppercase tracking-widest text-slate-400 font-bold mb-2">Penalty Ball</div>
                <h3 class="text-4xl font-black mb-2 text-white" id="penalty-team-name">紅隊投擲</h3>
                <p class="text-xl text-slate-300" id="penalty-info">剩餘 1 球</p>
            </div>
            
            <div class="relative mb-10">
                <button onclick="togglePenaltyTimer()" class="w-full">
                    <div class="text-[7rem] md:text-[10rem] font-black text-white font-mono tabular-nums leading-none cursor-pointer hover:text-emerald-400 transition drop-shadow-2xl" id="penalty-timer">01:00</div>
                </button>
                <div class="text-sm text-slate-500 mt-4">點擊時間 開始 / 暫停</div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <button onclick="penaltyScore()" class="py-5 bg-emerald-600 hover:bg-emerald-500 text-white rounded-2xl font-bold text-2xl transition flex items-center justify-center gap-3 shadow-lg active:scale-95">
                    <i data-lucide="trophy"></i> 投進得分 (+1)
                </button>
                <button onclick="nextPenaltyShot()" class="py-5 bg-slate-700 hover:bg-slate-600 text-slate-200 border border-slate-500 rounded-2xl font-bold text-2xl transition active:scale-95">
                    未得分 / 下一球
                </button>
            </div>
        </div>
    </div>

    <!-- 局間休息 Modal -->
    <div id="break-modal" class="hidden fixed inset-0 z-[110] bg-black/90 flex items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-slate-800 border-2 border-amber-500/50 p-8 rounded-3xl max-w-md w-full text-center shadow-2xl relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-3 bg-gradient-to-r from-amber-600 to-yellow-400"></div>
            <h3 class="text-3xl font-bold mb-2 text-amber-500 mt-4">局間休息 (Break)</h3>
            <p class="text-slate-400 text-base mb-8">準備進行第 <span id="next-end-number" class="text-white font-bold text-xl">1</span> 局</p>
            <div class="text-9xl font-black text-white mb-10 font-mono tabular-nums" id="break-timer-display">60</div>
            <button onclick="skipBreak()" class="w-full py-5 bg-slate-700 hover:bg-slate-600 text-white rounded-2xl font-bold text-2xl transition flex items-center justify-center gap-3 shadow-lg">
                <i data-lucide="skip-forward"></i> 跳過 / 開始下一局
            </button>
        </div>
    </div>

    <!-- 設定 Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm" onclick="toggleModal('settings-modal', false)">
        <div class="bg-slate-800 p-6 rounded-3xl max-w-md w-full border border-slate-700 shadow-2xl overflow-y-auto max-h-[85vh]" onclick="event.stopPropagation()">
            <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-3"><i data-lucide="settings"></i> 賽制設定</h2>
            
            <div class="space-y-3 mb-8">
                <button onclick="setGameMode('BC1')" class="w-full p-4 bg-slate-700 hover:bg-blue-600 rounded-xl flex justify-between items-center group transition"><span class="font-bold text-lg">BC1 個人賽</span><span class="text-sm text-slate-400 group-hover:text-white">4 局 / 4:30</span></button>
                <button onclick="setGameMode('BC2')" class="w-full p-4 bg-slate-700 hover:bg-blue-600 rounded-xl flex justify-between items-center group transition"><span class="font-bold text-lg">BC2 / BC4 個人賽</span><span class="text-sm text-slate-400 group-hover:text-white">4 局 / 3:30</span></button>
                <button onclick="setGameMode('BC3')" class="w-full p-4 bg-slate-700 hover:bg-blue-600 rounded-xl flex justify-between items-center group transition"><span class="font-bold text-lg">BC3 個人賽</span><span class="text-sm text-slate-400 group-hover:text-white">4 局 / 6:00</span></button>
                <button onclick="setGameMode('Team')" class="w-full p-4 bg-slate-700 hover:bg-blue-600 rounded-xl flex justify-between items-center group transition"><span class="font-bold text-lg">團體賽 (Team)</span><span class="text-sm text-slate-400 group-hover:text-white">6 局 / 5:00</span></button>
                <button onclick="setGameMode('PairBC3')" class="w-full p-4 bg-slate-700 hover:bg-blue-600 rounded-xl flex justify-between items-center group transition"><span class="font-bold text-lg">BC3 雙人賽</span><span class="text-sm text-slate-400 group-hover:text-white">4 局 / 7:00</span></button>
                <button onclick="setGameMode('PairBC4')" class="w-full p-4 bg-slate-700 hover:bg-blue-600 rounded-xl flex justify-between items-center group transition"><span class="font-bold text-lg">BC4 雙人賽</span><span class="text-sm text-slate-400 group-hover:text-white">4 局 / 4:00</span></button>
                <button onclick="setGameMode('WarmUpOnly')" class="w-full p-4 bg-slate-700 hover:bg-emerald-600 rounded-xl flex justify-between items-center group transition"><span class="font-bold text-lg">僅計時暖身 (2:00)</span><span class="text-sm text-slate-400 group-hover:text-white">不進入正規局</span></button>
            </div>

            <hr class="border-slate-600 my-6">

            <h3 class="text-lg font-bold text-amber-400 mb-4 flex items-center gap-2"><i data-lucide="timer"></i> 特殊暫停 (10分鐘)</h3>
            <div class="grid grid-cols-1 gap-3">
                <button onclick="startTimeout('medical')" class="w-full p-4 bg-red-900/40 border border-red-500/50 rounded-xl flex items-center justify-between hover:bg-red-900/60 transition group">
                    <span class="font-bold text-red-300 group-hover:text-white">醫療暫停 (Medical)</span>
                    <span class="text-sm font-mono text-red-400 font-bold">10:00</span>
                </button>
                <button onclick="startTimeout('technical')" class="w-full p-4 bg-amber-900/40 border border-amber-500/50 rounded-xl flex items-center justify-between hover:bg-amber-900/60 transition group">
                    <span class="font-bold text-amber-300 group-hover:text-white">技術暫停 (Technical)</span>
                    <span class="text-sm font-mono text-amber-400 font-bold">10:00</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 保持原有的重置/結束/Help Modal -->
    <div id="reset-modal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-slate-800 border border-slate-700 p-8 rounded-3xl max-w-sm w-full text-center shadow-2xl">
            <h3 class="text-xl font-bold mb-4 text-amber-500">重置本局？</h3>
            <p class="text-slate-300 text-sm mb-6">這將重置本局的時間與球數，但保留總分。</p>
            <div class="flex gap-3">
                <button onclick="toggleModal('reset-modal', false)" class="flex-1 py-3 bg-slate-700 rounded-xl font-bold">取消</button>
                <button onclick="resetCurrentEnd()" class="flex-1 py-3 bg-red-600 rounded-xl font-bold">確定重置</button>
            </div>
        </div>
    </div>

    <div id="game-over-modal" class="hidden fixed inset-0 z-[100] bg-slate-900/95 backdrop-blur-md flex items-center justify-center p-4">
        <div class="bg-slate-800 border-2 border-slate-700 p-10 rounded-[3rem] shadow-2xl max-w-2xl w-full text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-red-500 via-purple-500 to-sky-500"></div>
            <i data-lucide="trophy" class="mx-auto text-amber-500 w-20 h-20 mb-6"></i>
            <h2 class="text-3xl font-black text-slate-400 mb-6">比賽結果</h2>
            <div class="flex justify-center items-center gap-8 mb-8">
                <div class="text-center"><div class="text-slate-500 mb-2">紅隊</div><div id="final-red-score" class="text-8xl font-black text-red-500">0</div></div>
                <div class="text-4xl text-slate-600">:</div>
                <div class="text-center"><div class="text-slate-500 mb-2">藍隊</div><div id="final-blue-score" class="text-8xl font-black text-sky-500">0</div></div>
            </div>
            <div id="winner-text" class="text-4xl font-bold text-white mb-8"></div>
            <div class="flex flex-col gap-3">
                <button onclick="resetMatch()" class="bg-blue-600 hover:bg-blue-500 text-white px-8 py-4 rounded-xl font-bold text-xl w-full">
                    開始新比賽
                </button>
            </div>
        </div>
    </div>

    <div id="help-modal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm" onclick="toggleModal('help-modal', false)">
        <div class="bg-slate-800 p-8 rounded-3xl max-w-lg w-full border border-slate-700 overflow-y-auto max-h-[80vh]" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold text-blue-400">操作說明</h2><button onclick="toggleModal('help-modal', false)"><i data-lucide="x-circle"></i></button></div>
            <div class="space-y-4 text-slate-300 text-sm">
                <div class="bg-slate-900/50 p-4 rounded-xl"><h3 class="font-bold text-white mb-2">罰球 (Penalty)</h3><p>在紅/藍隊伍區點擊「+」記錄獲得的罰球數量。當正規時間結束點擊「下一局」時，若有未執行的罰球，系統會自動進入罰球執行模式 (每球 1 分鐘)。</p></div>
                <div class="bg-slate-900/50 p-4 rounded-xl"><h3 class="font-bold text-white mb-2">特殊暫停</h3><p>點擊上方「設定」按鈕，在選單最下方可啟動 10 分鐘的醫療或技術暫停。</p></div>
            </div>
        </div>
    </div>

    <script>
        // --- 狀態管理 ---
        let state = {
            gameType: 'BC1',
            matchTimePerEnd: 270,
            timePerEnd: 270,
            totalEnds: 4,
            currentEnd: 1,
            isWarmUp: true,
            warmUpType: 'simultaneous',
            red: { score: 0, timeLeft: 120, ballsPlayed: 0, timerStarts: 0, penaltyBalls: 0 },
            blue: { score: 0, timeLeft: 120, ballsPlayed: 0, timerStarts: 0, penaltyBalls: 0 },
            activeSide: null,
            timerInterval: null
        };
        
        let breakInterval = null;
        let specialTimeoutInterval = null;
        let penaltyState = { active: false, currentTeam: null, remaining: 0, timer: 60, isTimerRunning: false, timerInterval: null };

        document.addEventListener('DOMContentLoaded', () => {
            initBallsUI();
            updateDisplay();
            lucide.createIcons();
        });

        // --- 核心邏輯 (計時、球數) ---
        function activateSide(side) {
            if (state.isWarmUp && state.warmUpType === 'simultaneous') {
                if (state.activeSide === 'both') { pauseGame(); return; }
                clearInterval(state.timerInterval);
                state.activeSide = 'both';
                updateActiveStatus();
                state.timerInterval = setInterval(() => {
                    if (state.red.timeLeft > 0) state.red.timeLeft--;
                    if (state.blue.timeLeft > 0) state.blue.timeLeft--;
                    updateTimerDisplay('red'); updateTimerDisplay('blue');
                    if (state.red.timeLeft <= 0) { clearInterval(state.timerInterval); alert("暖身結束！"); }
                }, 1000);
                return;
            }
            if (side === state.activeSide) { pauseGame(); return; }
            clearInterval(state.timerInterval);
            state.activeSide = side;
            if (!state.isWarmUp) { state[side].timerStarts++; updateBallsFromTimer(side); }
            updateActiveStatus();
            state.timerInterval = setInterval(() => {
                if (state[side].timeLeft > 0) {
                    state[side].timeLeft--;
                    updateTimerDisplay(side);
                } else {
                    clearInterval(state.timerInterval);
                    alert((side === 'red' ? '紅隊' : '藍隊') + " 時間到！");
                }
            }, 1000);
        }

        function updateBallsFromTimer(side) {
            if (state.isWarmUp) return;
            const isOddEnd = state.currentEnd % 2 !== 0;
            const jackOwner = isOddEnd ? 'red' : 'blue';
            let ballsToMark = side === jackOwner ? state[side].timerStarts - 1 : state[side].timerStarts;
            ballsToMark = Math.max(0, Math.min(6, ballsToMark));
            state[side].ballsPlayed = ballsToMark;
            renderBalls(side);
        }

        function pauseGame() {
            clearInterval(state.timerInterval);
            state.activeSide = null;
            updateActiveStatus();
        }

        function adjustScore(side, delta) {
            state[side].score = Math.max(0, state[side].score + delta);
            document.getElementById(`${side}-score`).textContent = state[side].score;
        }

        // --- 罰球設定與執行邏輯 ---
        function adjustPenaltyBalls(side, delta) {
            state[side].penaltyBalls = Math.max(0, state[side].penaltyBalls + delta);
            document.getElementById(`${side}-penalty-count`).textContent = state[side].penaltyBalls;
        }

        function nextEnd() {
            if (state.isWarmUp) {
                state.isWarmUp = false;
                state.currentEnd = 1;
                resetCurrentEnd(false);
            } else {
                if (state.red.penaltyBalls > 0 || state.blue.penaltyBalls > 0) {
                    startPenaltyPhase();
                } else if (state.currentEnd < state.totalEnds) {
                    startBreak(state.currentEnd + 1);
                } else {
                    endMatch();
                }
            }
        }

        function startPenaltyPhase() {
            pauseGame();
            penaltyState.active = true;
            if (state.red.penaltyBalls > 0) { setupPenaltyShot('red'); } else { setupPenaltyShot('blue'); }
            toggleModal('penalty-modal', true);
        }

        function setupPenaltyShot(team) {
            penaltyState.currentTeam = team;
            penaltyState.remaining = state[team].penaltyBalls;
            penaltyState.timer = 60;
            penaltyState.isTimerRunning = false;
            if(penaltyState.timerInterval) clearInterval(penaltyState.timerInterval);
            
            const name = document.getElementById('penalty-team-name');
            const infoText = document.getElementById('penalty-info');
            const timerText = document.getElementById('penalty-timer');
            const bar = document.getElementById('penalty-bar');
            
            name.textContent = team === 'red' ? '紅隊投擲' : '藍隊投擲';
            name.className = team === 'red' ? 'text-4xl font-black mb-2 text-red-500' : 'text-4xl font-black mb-2 text-sky-500';
            infoText.textContent = `剩餘 ${penaltyState.remaining} 顆罰球`;
            timerText.textContent = "01:00";
            timerText.classList.remove('text-amber-400', 'text-red-500');
            bar.className = team === 'red' ? "absolute top-0 left-0 w-full h-4 bg-red-600" : "absolute top-0 left-0 w-full h-4 bg-sky-600";
        }

        function togglePenaltyTimer() {
            if (penaltyState.isTimerRunning) {
                clearInterval(penaltyState.timerInterval);
                penaltyState.isTimerRunning = false;
            } else {
                penaltyState.isTimerRunning = true;
                penaltyState.timerInterval = setInterval(() => {
                    penaltyState.timer--;
                    const m = Math.floor(penaltyState.timer / 60);
                    const s = penaltyState.timer % 60;
                    document.getElementById('penalty-timer').textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                    if(penaltyState.timer <= 0) { clearInterval(penaltyState.timerInterval); penaltyState.isTimerRunning = false; alert("罰球時間到！"); }
                }, 1000);
            }
        }

        function penaltyScore() {
            if (penaltyState.currentTeam) adjustScore(penaltyState.currentTeam, 1);
        }

        function nextPenaltyShot() {
            state[penaltyState.currentTeam].penaltyBalls--;
            document.getElementById(`${penaltyState.currentTeam}-penalty-count`).textContent = state[penaltyState.currentTeam].penaltyBalls;
            if (state[penaltyState.currentTeam].penaltyBalls > 0) {
                setupPenaltyShot(penaltyState.currentTeam);
            } else {
                const otherTeam = penaltyState.currentTeam === 'red' ? 'blue' : 'red';
                if (penaltyState.currentTeam === 'red' && state.blue.penaltyBalls > 0) {
                    setupPenaltyShot('blue');
                } else {
                    toggleModal('penalty-modal', false);
                    if (state.currentEnd < state.totalEnds) startBreak(state.currentEnd + 1); else endMatch();
                }
            }
        }

        // --- 特殊暫停邏輯 ---
        function startTimeout(type) {
            toggleModal('settings-modal', false); toggleModal('timeout-active-modal', true); pauseGame();
            const title = document.getElementById('timeout-title'); const timer = document.getElementById('timeout-timer');
            title.textContent = type === 'medical' ? "醫療暫停 (Medical)" : "技術暫停 (Technical)";
            title.className = type === 'medical' ? "text-4xl md:text-6xl font-black text-red-500 mb-12 animate-pulse" : "text-4xl md:text-6xl font-black text-amber-500 mb-12 animate-pulse";
            let timeLeft = 600; timer.textContent = "10:00";
            if (specialTimeoutInterval) clearInterval(specialTimeoutInterval);
            specialTimeoutInterval = setInterval(() => {
                timeLeft--; const m = Math.floor(timeLeft / 60); const s = timeLeft % 60;
                timer.textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                if (timeLeft <= 0) { clearInterval(specialTimeoutInterval); alert("暫停時間結束！"); }
            }, 1000);
        }

        function endSpecialTimeout() {
            if (specialTimeoutInterval) clearInterval(specialTimeoutInterval); toggleModal('timeout-active-modal', false);
        }

        // --- 局間休息邏輯 ---
        function startBreak(nextEndNum) {
            pauseGame();
            document.getElementById('next-end-number').textContent = nextEndNum;
            toggleModal('break-modal', true);
            let timeLeft = 60; const display = document.getElementById('break-timer-display');
            display.textContent = timeLeft; display.classList.remove('text-red-500'); 
            if (breakInterval) clearInterval(breakInterval);
            breakInterval = setInterval(() => {
                timeLeft--; display.textContent = timeLeft;
                if (timeLeft <= 15) display.classList.add('text-red-500');
                if (timeLeft <= 0) skipBreak();
            }, 1000);
        }
        
        function skipBreak() {
            if (breakInterval) clearInterval(breakInterval);
            toggleModal('break-modal', false);
            state.currentEnd++; resetCurrentEnd(true);
        }

        // --- 通用/重置功能 ---
        function setGameMode(mode) {
            state.gameType = mode;
            let time = 270; let ends = 4; let isWarmUpOnly = false; let warmUpType = 'simultaneous';
            switch(mode) {
                case 'BC1': time = 270; ends = 4; warmUpType = 'simultaneous'; break;
                case 'BC2': time = 210; ends = 4; warmUpType = 'simultaneous'; break;
                case 'BC3': time = 360; ends = 4; warmUpType = 'simultaneous'; break;
                case 'BC4': time = 210; ends = 4; warmUpType = 'simultaneous'; break;
                case 'Team': time = 300; ends = 6; warmUpType = 'separate'; break;
                case 'PairBC3': time = 420; ends = 4; warmUpType = 'separate'; break;
                case 'PairBC4': time = 240; ends = 4; warmUpType = 'separate'; break;
                case 'WarmUpOnly': time = 120; ends = 1; isWarmUpOnly = true; warmUpType = 'simultaneous'; break;
            }
            state.matchTimePerEnd = time; state.totalEnds = ends; state.warmUpType = warmUpType; state.currentEnd = 1;
            if (isWarmUpOnly) { state.isWarmUp = true; state.timePerEnd = 120; } else { state.isWarmUp = true; state.timePerEnd = 120; }
            let modeText = mode;
            if (mode === 'PairBC3') modeText = "BC3 雙人"; if (mode === 'PairBC4') modeText = "BC4 雙人"; if (mode === 'Team') modeText = "團體賽"; if (mode === 'WarmUpOnly') modeText = "僅暖身";
            document.getElementById('center-class-display').textContent = modeText.split(' ')[0];
            document.getElementById('header-mode-text').textContent = `${modeText}`;
            resetMatch(true); toggleModal('settings-modal', false);
        }

        function resetCurrentEnd(keepScore = true) {
            clearInterval(state.timerInterval); state.activeSide = null;
            const timeToSet = state.isWarmUp ? 120 : state.matchTimePerEnd;
            state.red.timeLeft = timeToSet; state.blue.timeLeft = timeToSet;
            state.red.ballsPlayed = 0; state.blue.ballsPlayed = 0; state.red.timerStarts = 0; state.blue.timerStarts = 0;
            state.red.penaltyBalls = 0; state.blue.penaltyBalls = 0; 
            document.getElementById('red-penalty-count').textContent = 0; document.getElementById('blue-penalty-count').textContent = 0;
            if (!keepScore) { state.red.score = 0; state.blue.score = 0; }
            updateDisplay(); renderBalls('red'); renderBalls('blue'); toggleModal('reset-modal', false);
        }

        function resetMatch(keepSettings = false) {
            clearInterval(state.timerInterval); state.activeSide = null;
            if (state.gameType !== 'WarmUpOnly') state.isWarmUp = true;
            state.currentEnd = 1; state.red.score = 0; state.blue.score = 0;
            state.red.penaltyBalls = 0; state.blue.penaltyBalls = 0;
            const timeToSet = 120;
            state.red.timeLeft = timeToSet; state.blue.timeLeft = timeToSet;
            state.red.ballsPlayed = 0; state.blue.ballsPlayed = 0;
            state.red.timerStarts = 0; state.blue.timerStarts = 0;
            document.getElementById('red-penalty-count').textContent = 0; document.getElementById('blue-penalty-count').textContent = 0;
            updateDisplay(); renderBalls('red'); renderBalls('blue'); toggleModal('game-over-modal', false);
        }

        function endMatch() {
            clearInterval(state.timerInterval);
            document.getElementById('final-red-score').textContent = state.red.score;
            document.getElementById('final-blue-score').textContent = state.blue.score;
            let winnerText = "";
            if (state.red.score > state.blue.score) winnerText = `<span class="text-pink-500">紅隊獲勝！</span>`;
            else if (state.blue.score > state.red.score) winnerText = `<span class="text-sky-500">藍隊獲勝！</span>`;
            else winnerText = `<span class="text-amber-500">平局 (Tie Break)</span>`;
            document.getElementById('winner-text').innerHTML = winnerText;
            toggleModal('game-over-modal', true);
        }

        function initBallsUI() { renderBalls('red'); renderBalls('blue'); }
        function renderBalls(side) {
            const container = document.getElementById(`${side}-balls-container`); container.innerHTML = '';
            const playedCount = state[side].ballsPlayed; const colorClass = side === 'red' ? 'ball-red' : 'ball-blue';
            for(let i=0; i<6; i++) {
                const ball = document.createElement('button');
                let className = `boccia-ball w-8 h-8 md:w-10 md:h-10 rounded-full border-2 shadow-sm ${colorClass}`;
                if (i < playedCount) className += ' ball-filled';
                ball.className = className;
                ball.onclick = () => manualToggleBall(side, i);
                container.appendChild(ball);
            }
        }
        function manualToggleBall(side, index) {
            if (index < state[side].ballsPlayed) state[side].ballsPlayed = index; else state[side].ballsPlayed = index + 1;
            renderBalls(side);
        }

        function updateDisplay() {
            const centerText = document.getElementById('center-end-display');
            const subText = document.getElementById('total-ends-container');
            const nextBtnText = document.getElementById('next-btn-text');
            const nextBtn = document.getElementById('next-btn');
            const jackEl = document.getElementById('jack-indicator');

            if (state.isWarmUp) {
                centerText.textContent = "暖身"; centerText.className = "text-white text-3xl lg:text-5xl mx-1 font-black";
                let warmUpModeText = state.warmUpType === 'simultaneous' ? "同時暖身" : "分開暖身";
                subText.textContent = `Warm Up - ${warmUpModeText}`;
                nextBtnText.textContent = "開始比賽 (Start)";
                nextBtn.className = "py-3 md:py-4 bg-emerald-600 text-white rounded-xl font-bold hover:bg-emerald-500 transition shadow-lg flex items-center justify-center gap-2 text-sm md:text-base";
                jackEl.textContent = "暖身時間"; jackEl.className = "bg-slate-700 text-slate-300 px-4 py-2 rounded-lg font-bold text-sm";
            } else {
                centerText.textContent = state.currentEnd; centerText.className = "text-white text-4xl lg:text-6xl mx-1 font-black";
                subText.innerHTML = `共 <span id="center-total-ends">${state.totalEnds}</span> 局`;
                nextBtnText.textContent = "下一局 (Next End)";
                nextBtn.className = "py-3 md:py-4 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-500 transition shadow-lg flex items-center justify-center gap-2 text-sm md:text-base";
                const isOddEnd = state.currentEnd % 2 !== 0;
                if (isOddEnd) { jackEl.textContent = "紅方發球 (Jack: Red)"; jackEl.className = "bg-red-900/50 text-red-200 border border-red-800 text-slate-300 px-4 py-2 rounded-lg font-bold text-sm"; } 
                else { jackEl.textContent = "藍方發球 (Jack: Blue)"; jackEl.className = "bg-sky-900/50 text-sky-200 border border-sky-800 text-slate-300 px-4 py-2 rounded-lg font-bold text-sm"; }
            }
            updateTimerDisplay('red'); updateTimerDisplay('blue'); updateActiveStatus();
        }

        function updateTimerDisplay(side) {
            document.getElementById(`${side}-timer-btn`).textContent = formatTime(state[side].timeLeft);
            if (state[side].timeLeft <= 30) {
                 document.getElementById(`${side}-timer-btn`).classList.add('text-amber-400');
                 document.getElementById(`${side}-timer-btn`).classList.remove(side === 'red' ? 'text-red-400' : 'text-sky-400');
            } else {
                 document.getElementById(`${side}-timer-btn`).classList.remove('text-amber-400');
                 document.getElementById(`${side}-timer-btn`).classList.add(side === 'red' ? 'text-red-400' : 'text-sky-400');
            }
        }

        function updateActiveStatus() {
            const redBg = document.getElementById('red-active-bg'); const blueBg = document.getElementById('blue-active-bg');
            const redPanel = document.getElementById('red-panel'); const bluePanel = document.getElementById('blue-panel');
            redBg.classList.add('hidden'); blueBg.classList.add('hidden');
            redPanel.classList.remove('ring-4', 'ring-red-500', 'scale-[1.02]'); bluePanel.classList.remove('ring-4', 'ring-sky-500', 'scale-[1.02]');
            redPanel.classList.add('opacity-60'); bluePanel.classList.add('opacity-60');
            
            if (state.activeSide === 'both') {
                redBg.classList.remove('hidden'); redPanel.classList.add('ring-4', 'ring-red-500', 'scale-[1.02]'); redPanel.classList.remove('opacity-60');
                blueBg.classList.remove('hidden'); bluePanel.classList.add('ring-4', 'ring-sky-500', 'scale-[1.02]'); bluePanel.classList.remove('opacity-60');
            } else if (state.activeSide === 'red') {
                redBg.classList.remove('hidden'); redPanel.classList.add('ring-4', 'ring-red-500', 'scale-[1.02]'); redPanel.classList.remove('opacity-60');
            } else if (state.activeSide === 'blue') {
                blueBg.classList.remove('hidden'); bluePanel.classList.add('ring-4', 'ring-sky-500', 'scale-[1.02]'); bluePanel.classList.remove('opacity-60');
            }
            lucide.createIcons();
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60); const s = seconds % 60;
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function toggleModal(id, show) {
            const el = document.getElementById(id);
            if (show) el.classList.remove('hidden'); else el.classList.add('hidden');
        }
    </script>
</body>
</html>